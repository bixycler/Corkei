<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FABRIK Chain</title>
  <style>
    #twoCanvas :first-child { margin: 0; background: DimGray; }
    canvas { display: block; }
    body {
      max-width: 800px;
      margin: 0 auto;
    }
  </style>
</head>

<body>

<input type="checkbox" id="fixedBase" name="fixedBase" checked>
<label for="fixedBase">Fixed Base</label>
&emsp;&emsp;
<label for="numSegs">Number of Segments:
  <output id="numSegsOutput" name="numSegsOutput" style="display: inline-block; width: 1em;">10</output>
</label>
<input type="range" id="numSegs" name="numSegs" min="1" max="30" value="10"
  oninput="this.previousElementSibling.firstElementChild.value = this.value">
&emsp;
<input type="checkbox" id="shadow" name="shadow" checked>
<label for="shadow">Shadow</label>

<div id="twoCanvas"></div>
<script type="module" src="FabrikDemo-TwoJS.js"></script>

<label for="targetCoords">Target: </label>
<input type="text" id="targetCoords" name="targetCoords" size="7">
<input type="checkbox" id="fixedTarget" name="fixedTarget">
<label for="fixedTarget">Fixed Target</label>
&emsp;&emsp;
<button id="saveImage">Save Image</button>
<a id="downloadImage" download="FabrikDemo.svg" hidden></a>

<p>
  Instruction:
  <ul>
    <li><b>Drag</b> the tip <span style="color:red;">‚óâ</span> (red-circled end) to see the effect üòâ. This tip is the end effector which will (try to) follow the red-circled target.</li>
    <li>Its base (the other end) can be released by unchecking ‚ÄúFixed Base‚Äù.</li>
    <li>Number of segments: Increase to see smoother transformation; Decrease to see its mechanism, esp. the basic with a single segment.</li>
    <li>The last position can be shown as a shadow chain (<a href="https://en.wikipedia.org/wiki/Ghosting_(television)">ghost</a>) by checking ‚ÄúShadow‚Äù.</li>
    <li>Hold <b>Ctrl</b> key down to keep the last position unchanged.</li>
    <li>For more details, see the Explantion below.</li>
  </ul>
</p>

<details><summary>Explantion</summary>

<p>
This applet shows the non-iterative version of <a href="http://www.andreasaristidou.com/FABRIK.html">Forward And Backward Reaching Inverse Kinematics (FABRIK)</a>, which comprises only two passes (backward and forward propagation) for the fixed base chain, and only one pass (backward propagation) for the free base chain. The one-pass version is the <a href="https://dl.acm.org/doi/10.1007/s00371-003-0226-y">‚ÄúFollow-the-Leader‚Äù technique</a> floating in the air before 2004.
</p>

<h3>Basic Case: a Free Rod</h3>

<img src="media/one-segment-free-base-shadow.svg">
<p>
  When a single-segment chain (a rod) is pulled at one end (effector) from P<sub>1</sub> to P<sub>1</sub>', the other end P<sub>0</sub> just follows P<sub>1</sub>' to move to P<sub>0</sub>' due to the length constraint of the segment. That means <b>P<sub>0</sub>' lies on the line P<sub>0</sub>P<sub>1</sub>'</b>.
</p>

<h3>Backward Propagation on a Free Chain</h3>

<img src="media/three-segments-free-base-shadow.svg">
<p>
  When a 3-segment chain is pulled at its tip from P<sub>3</sub> to P<sub>3</sub>', the third segment P<sub>2</sub>P<sub>3</sub>' just follows P<sub>3</sub>' like a free rod in the basic case, then the second segment P<sub>1</sub>P<sub>2</sub>' follows P<sub>2</sub>', and the first segment P<sub>0</sub>P<sub>1</sub>' follows P<sub>1</sub>'. The same for other multi-segment chains. This <b>propagation of change from the tip back to the base</b> is the backward pass in FABRIK.
</p>


<h3>Backward & Forward Propagation on a Fixed Base Chain</h3>

<img src="media/three-segments-fixed-base-shadow.svg">
<p>
  A 3-segment chain with its base fixed will <b>reflects the backward propagation</b> at the base so that <i>the change propagates from the base toward to the tip</i>. That means from the intermediate position of the previous case, the chain is pulled at its base toward the fixed center, then the first segment follows, and the second, third segments, too. The same for other multi-segment chains. This forward pass from the base to the tip, together with the previous backward pass, close the loop of one iteration in FABRIK.
</p>

<h3>FABRIK: Iterative Backward‚ÄìForward Propagation until Equilibrium</h3>

<video muted autoplay src="media/three-segments-iterative.webm" width="600" height="400" controls>
  Your browser does not support the video tag.
</video>
<p>
  Repeating the backward‚Äìforward propagation until equilibrium, we have the FABRIK algorithm. When the target is reachable, i.e. the chain length is greater than the distance to the target, FABRIK converges to the target position which is static. Otherwise, it converges to a straight chain oscillating between two ends (the target and the fixed center).
</p>


<h3>‚õ©Ô∏è Monument to the Ancestor üïå</h3>

<p>
In Macromedia Flash I saw,<br>
a chain that reached, then yielded, raw.<br>
No force was named, no sums were done,<br>
just step by step till rest was won.<br>
</p><p>
Simple strokes, yet deeply true,<br>
the wave that flows, the world I knew.<br>
Today I draw its motion here,<br>
a living monument, held dear.<br>
</p>

</details>

</body>
</html>
