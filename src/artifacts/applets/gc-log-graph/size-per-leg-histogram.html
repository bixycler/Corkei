<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Histogram of Number of Flight Search Results</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --primary-color: #4a90e2;
            --secondary-color: #f5f7fa;
            --text-color: #333;
            --accent-color: #ff6b6b;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-color);
            margin: 0;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        header {
            margin-bottom: 2rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .histogram-container {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
            width: 100%;
            max-width: 900px;
        }

        .histogram-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 0.5rem;
        }

        .bar {
            fill: var(--primary-color);
            transition: fill 0.2s;
        }

        .bar:hover {
            fill: var(--accent-color);
        }

        .axis-label {
            font-size: 0.85rem;
            fill: #777;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 100;
        }

        .no-data {
            font-style: italic;
            color: #999;
        }

        .controls {
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            background: white;
            padding: 1rem 2rem;
            border-radius: 50px;
            box-shadow: var(--shadow);
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .btn-upload {
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            background-color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-upload:hover {
            background-color: var(--primary-color);
            color: white;
        }

        #file-input {
            font-size: 100px;
            /* Make it overlayed by our .btn-upload: position: absolute */
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <header>
        <h1>Histogram of Number of Flight Search Results</h1>
        <p>Visualizing results count distribution per journey leg count</p>
    </header>

    <div class="controls">
        <div class="file-input-wrapper">
            <button class="btn-upload">Upload JSON</button>
            <input type="file" id="file-input" accept=".json" />
        </div>
        <span id="file-name" style="font-size: 0.9rem; color: #666;">size-per-leg.json (default)</span>
    </div>

    <div id="histograms"></div>
    <div id="tooltip" class="tooltip"></div>

    <script>
        const container = d3.select("#histograms");
        const tooltip = d3.select("#tooltip");
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name');

        async function loadAndDraw(source = 'size-per-leg.json') {
            try {
                let data;
                if (typeof source === 'string') {
                    const response = await fetch(source);
                    data = await response.json();
                } else {
                    data = source;
                }

                renderData(data);
            } catch (error) {
                console.error("Error loading/rendering JSON:", error);
                container.html("");
                container.append("p").text("Error loading/rendering data. Make sure the file is valid JSON.").style("color", "red");
            }
        }

        fileInput.addEventListener('change', function (e) {
            const file = e.target.files?.[0];
            if (!file) return;

            fileNameDisplay.textContent = file.name;
            const reader = new FileReader();
            reader.onload = function (event) {
                const data = JSON.parse(event.target.result);
                loadAndDraw(data);
            };
            reader.readAsText(file);
        });

        function renderData(data) {
            container.html("");

            if (!data || data.length === 0) {
                container.append("p").text("No data found").attr("class", "no-data");
                return;
            }

            data.forEach((legData, index) => {
                if (!legData || legData.length === 0) {
                    console.log(`No data found for journey with ${index} leg`);
                    return;
                }

                const wrapper = container.append("div").attr("class", "histogram-container");
                wrapper.append("div").attr("class", "histogram-title").text(`Journey with ${index} Leg${index > 1 ? 's' : ''}`);

                drawHistogram(wrapper, legData, tooltip);
                console.log(`Histogram rendered for journey with ${index} leg`);
            });
        }

        function drawHistogram(container, data, tooltip) {
            const margin = { top: 20, right: 30, bottom: 50, left: 60 };
            const width = 800 - margin.left - margin.right;
            const height = 400 - margin.top - margin.bottom;

            const svg = container.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // X scale
            const x = d3.scaleLinear()
                .domain([0, d3.max(data)])
                .nice()
                .range([0, width]);

            // Y scale
            const histogram = d3.bin()
                .domain(x.domain())
                .thresholds(x.ticks(10 + Math.min(data.length / 20, 100))); // Adjust number of bins

            const bins = histogram(data);

            const y = d3.scaleLinear()
                .domain([0, d3.max(bins, d => d.length)])
                .nice()
                .range([height, 0]);

            // Add X axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .append("text")
                .attr("class", "axis-label")
                .attr("x", width / 2)
                .attr("y", 40)
                .attr("text-anchor", "middle")
                .text("Number of Results");

            // Add Y axis
            svg.append("g")
                .call(d3.axisLeft(y))
                .append("text")
                .attr("class", "axis-label")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -45)
                .attr("text-anchor", "middle")
                .text("Frequency");

            // Add bars
            svg.selectAll(".bar")
                .data(bins)
                .enter().append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.x0) + 1)
                .attr("width", d => Math.max(0, x(d.x1) - x(d.x0) - 1))
                .attr("y", d => y(d.length))
                .attr("height", d => height - y(d.length))
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1)
                        .html(`Range: ${d.x0} - ${d.x1}<br/>Count: ${d.length}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mousemove", (event) => {
                    tooltip.style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    tooltip.style("opacity", 0);
                });

            // Add mean marker
            const mean = d3.mean(data);
            if (mean !== undefined) {
                svg.append("line")
                    .attr("class", "mean-line")
                    .attr("x1", x(mean))
                    .attr("x2", x(mean))
                    .attr("y1", 0)
                    .attr("y2", height)
                    .attr("stroke", "var(--accent-color)")
                    .attr("stroke-width", 2)
                    .attr("stroke-dasharray", "4,4");

                svg.append("text")
                    .attr("class", "mean-label")
                    .attr("x", x(mean) + 5)
                    .attr("y", 15)
                    .attr("fill", "var(--accent-color)")
                    .attr("font-size", "0.85rem")
                    .attr("font-weight", "600")
                    .text(`Mean: ${d3.format(",.2f")(mean)}`);
            }
        }

        loadAndDraw();
    </script>

</body>

</html>